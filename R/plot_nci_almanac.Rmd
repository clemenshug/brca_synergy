---
title: "Plot NCI data"
author: "Clemens Hug"
date: "6/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(here)
library(ggbeeswarm)
library(patchwork)

dir_data <- here("data")
dir.create(dir_data, showWarnings = FALSE)
dir_res <- here("nci")
dir.create(dir_res, showWarnings = FALSE)

synapser::synLogin()
syn <- synExtra::synDownloader(dir_data)
```

## Load data from Synapse

```{r load}
growth_data_raw <- syn("syn25882596") %>%
  read_csv()
meta_cell_line <- syn("syn25882595") %>%
  read_csv()
meta_drugs <- syn("syn25882594") %>%
  read_csv()
```

## Format data for plotting

PercentGrowth    NUMBER           percent growth of drug combination
against cell line, using time zero in
calculation
PercentGrowthNoTZ NUMBER          percent growth without time zero
TestValue         NUMBER          test mean optical density
ControlValue      NUMBER          vehicle control mean optical density
TZValue           NUMBER          time zero mean optical density
ExpectedGrowth    NUMBER          expected percent growth for combination,
based on values for individual drugs
Score             NUMBER(4)       score, for combination records

```{r gr}
compute_metrics <- function(data) {
  mutate(
    data,
    fraction_killing = 1 - (TESTVALUE / CONTROLVALUE),
    log_killing = log10(CONTROLVALUE / TESTVALUE),
    gr = log2(TESTVALUE / TZVALUE) / log2(CONTROLVALUE / TZVALUE),
    gr_bound = 2**gr - 1
  )
}

growth_data <- growth_data_raw %>%
  compute_metrics()

growth_data_single_dose_all <- growth_data %>%
  filter(is.na(lspci_id_2)) %>%
  select(
    panel_id, cell_id,
    lspci_id = lspci_id_1,
    drug_concentration = drug_concentration_1,
    ends_with("killing"),
    ends_with("VALUE"),
    starts_with("gr")
  )

growth_data_single_dose_agg <- growth_data_single_dose_all %>%
  group_by(panel_id, cell_id, lspci_id, drug_concentration) %>%
  summarize(
    across(ends_with("VALUE"), mean),
    .groups = "drop"
  ) %>%
  compute_metrics()
  
growth_data_bliss_raw <- growth_data %>%
  filter(!is.na(lspci_id_2)) %>%
  left_join(
    growth_data_single_dose_agg %>%
      select(
        panel_id, cell_id,
        lspci_id_1 = lspci_id, drug_concentration_1 = drug_concentration,
        fraction_killing_1 = fraction_killing
      )
  ) %>%
  left_join(
    growth_data_single_dose_agg %>%
      select(
        panel_id, cell_id,
        lspci_id_2 = lspci_id, drug_concentration_2 = drug_concentration,
        fraction_killing_2 = fraction_killing
      )
  ) %>%
  mutate(
    fraction_killing_bliss_expected = fraction_killing_1 + fraction_killing_2 - fraction_killing_1 * fraction_killing_2,
    excess_killing = log10(1 - fraction_killing_bliss_expected) - log10(1 - fraction_killing)
  )
```

```{r gr_descriptive}
plt <- growth_data_gr %>%
  ggplot(aes(gr)) +
     geom_linerange(
      aes(q, ymin = -0.3, ymax = 0),
      data = ~quantile(.x$gr, seq(.1, 0.9, by = 0.1)) %>%
        enframe("quantile", "q")
    ) +
    geom_histogram(aes(y = stat(density))) +
    geom_density(color = "red") +
    lims(x = c(-2, NA))

ggsave(
  file.path(dir_res, "desc_gr_histogram.pdf"), plt,
  width = 4, height = 2
)

```


```{r plot_bliss}
growth_data_bliss_nested <- growth_data_bliss_raw %>%
  group_nest(
    panel_id, cell_id, lspci_id_1, lspci_id_2
  ) %>%
  left_join(
    meta_cell_line
  ) %>%
  left_join(
    select(meta_drugs, lspci_id_1 = lspci_id, pref_name_1 = pref_name)
  ) %>%
  left_join(
    select(meta_drugs, lspci_id_2 = lspci_id, pref_name_2 = pref_name)
  )

adam_cmap <- c(
  "#FFDA64", "#FFC952", "#FAB534", "#FCAB24", "#F79820", "#F48221", "#F4751C",
  "#EB6820", "#D95330", "#D04445", "#B93B51", "#953565", "#78287E", "#522B6E", "#22152F"
)

plot_gr <- function(panel_id, cell_id, lspci_ids, y = gr, highlight_conc = FALSE) {
  y_sym <- enquo(y)
  data_agg <- growth_data_single_dose_agg %>%
    filter(panel_id == !!panel_id, cell_id == !!cell_id, lspci_id %in% lspci_ids) %>%
    left_join(meta_drugs)
  data_all <- growth_data_single_dose_all %>%
    filter(panel_id == !!panel_id, cell_id == !!cell_id, lspci_id %in% lspci_ids) %>%
    left_join(meta_drugs)
  plt <- ggplot(data_agg, aes(drug_concentration, !!y_sym)) +
    geom_line(color = "gray") +
    geom_beeswarm(data = data_all, groupOnX = TRUE) +
    scale_x_log10() +
    labs(x = "Concentration") +
    theme_minimal()
  if (length(lspci_ids) > 1)
    plt <- plt + facet_wrap(vars(pref_name), scales = "free_x")
  if (highlight_conc) {
    conc_data <- growth_data_bliss_nested %>%
      filter(lspci_id_1 == lspci_ids[1], lspci_id_2 == lspci_ids[2]) %>%
      chuck("data", 1)
    plt$layers <- c(
      geom_linerange(
        aes(x = drug_concentration, y = NULL), ymin = -Inf, ymax = Inf,
        color = "gray50",
        data = bind_rows(
          transmute(conc_data, lspci_id = lspci_ids[1], drug_concentration = drug_concentration_1),
          transmute(conc_data, lspci_id = lspci_ids[2], drug_concentration = drug_concentration_2),
        ) %>%
          distinct() %>%
          left_join(meta_drugs)
      ), plt$layers
    )
  }
  plt
}

plot_bliss <- function(..., fill_var = NULL) {
  args <- list(...)
  if (is.null(fill_var))
    fill_var <- "fraction_killing"
  fill_var_sym <- sym(fill_var)
  data <- args$data[[1]] %>%
    mutate(across(c(drug_concentration_1, drug_concentration_2), ~fct_inseq(as.character(.x))))
  plt <- ggplot(data, aes(drug_concentration_1, drug_concentration_2, fill = !!fill_var_sym)) +
    geom_tile() +
    labs(
      title = paste(
        args$pref_name_1, "and", args$pref_name_2, "in", args$cell_name, paste0("(", args$panel_name, ")")
      ),
      x = paste(args$pref_name_1, "concentration"),
      y = paste(args$pref_name_2, "concentration"),
    ) +
    theme_minimal()
  if (fill_var %in% c("excess_killing"))
    plt <- plt + scale_fill_distiller(type = "div", palette = "RdBu", limits = c(-1, 1) * max(abs(data[[fill_var]])))
  else if (fill_var %in% c("gr"))
    # plt <- plt + scale_fill_viridis_c(option = "inferno", limits = c(-1.5, 1))
    plt <- plt + scale_fill_gradientn(colors = rev(adam_cmap), limits = c(-1.5, 1))
  else if (str_starts(fill_var, fixed("fraction_killing")) | fill_var %in% c("log_killing"))
    plt <- plt +
      scale_fill_viridis_c(direction = -1, trans = "log2", breaks = scales::log_breaks(base = 2))
      # scale_fill_gradientn(colors = pals::parula(100), trans = "log2", breaks = scales::log_breaks(base = 2))
  plt
}

plot_combo <- function(...) {
  args <- list(...)
  
  plot_bliss_l <- lift_dl(plot_bliss)
  
  plt <- (
      plot_bliss_l(args, fill_var = "excess_killing") + labs(x = NULL) |
      plot_bliss_l(args, fill_var = "gr") + labs(title = NULL, x = NULL, y = NULL)
    ) /
    (
      plot_bliss_l(args, fill_var = "fraction_killing") + labs(title = NULL) |
      plot_bliss_l(args, fill_var = "fraction_killing_bliss_expected") + labs(title = NULL, y = NULL)
    ) / plot_gr(args$panel_id, args$cell_id, c(args$lspci_id_1, args$lspci_id_2), highlight_conc = TRUE) /
      plot_gr(args$panel_id, args$cell_id, c(args$lspci_id_1, args$lspci_id_2), y = log_killing, highlight_conc = TRUE)
  plt
}
x <- growth_data_bliss_nested %>% filter(lspci_id_1 == 487093, lspci_id_2 == 631796, cell_id == 16, panel_id == 9)
plt <- lift_dl(plot_combo)(x)

plt <- lift_dl(plot_combo)(growth_data_bliss_nested[4, ])
plt

```

```{r bliss_vs_log_kill}

growth_data_bliss <- growth_data_bliss_raw %>%
  left_join(
    meta_cell_line
  ) %>%
  left_join(
    select(meta_drugs, lspci_id_1 = lspci_id, pref_name_1 = pref_name)
  ) %>%
  left_join(
    select(meta_drugs, lspci_id_2 = lspci_id, pref_name_2 = pref_name)
  )

growth_data_bliss_auc <- growth_data_bliss %>%
  group_by(panel_id, cell_id, lspci_id_1, lspci_id_2) %>%
  summarize(
    AUC = sum(excess_killing),
    gr_min = min(gr, na.rm = TRUE),
    gr_mean = mean(gr, na.rm = TRUE),
    excess_killing_gr_min = mean(excess_killing[gr == min(gr, na.rm = TRUE)]),
    log_killing_max = max(log_killing, na.rm = TRUE),
    excess_killing_log_killing_max =  mean(excess_killing[log_killing == max(log_killing, na.rm = TRUE)]),
    .groups = "drop"
  )

library(rasterly)

plot_scatter_rasterly <- function(data, x, y, out, out_dir = dir_res, ...) {
  args <- rlang::list2(...)
  x_sym <- enquo(x)
  y_sym <- enquo(y)
  df <- data %>%
    select(!!x_sym, !!y_sym) %>%
    drop_na()
  # plt <- df %>%
  #   rasterly(
  #     mapping = aes(x = !!x_sym, y = !!y_sym),
  #     plot_width = 1600, plot_height = 1200,
  #     drop_data = TRUE,
  #     ...
  #   ) %>% 
  #   rasterly_points(color = viridisLite::inferno(256))
  
  # gr <- rasterlyGrob(
  #   plt,
  #   xlab = args$xlab %||% rlang::as_name(x_sym),
  #   ylab = args$ylab %||% rlang::as_name(y_sym)
  # )
  plt <- ggRasterly(
    df, mapping = aes(x = !!x_sym, y = !!y_sym),
    plot_width = 1600, plot_height = 1200,
    shape = 16,
    color = viridisLite::inferno(256),
    ...
  ) +
    labs(x = args$xlab %||% rlang::as_name(x_sym), y = args$ylab %||% rlang::as_name(y_sym)) +
    scale_color_viridis_c(trans = "log10", option = "inferno") +
    theme_minimal()
  ggsave(
    file.path(out_dir, paste0(out, ".pdf")), plt,
    width = 12, height = 8
  )
}

plot_scatter_rasterly_2 <- function(data, x, y, out, out_dir = dir_res, ...) {
  args <- rlang::list2(...)
  x_sym <- enquo(x)
  y_sym <- enquo(y)
  df <- data %>%
    select(!!x_sym, !!y_sym) %>%
    drop_na()
  plt <- df %>%
    rasterly(
      mapping = aes(x = !!x_sym, y = !!y_sym),
      plot_width = 1600, plot_height = 1200,
      ...
    ) %>%
    rasterly_points(color = viridisLite::inferno(256)) %>%
    rasterly_build()
  # sum_mat <- plt$agg[[1]][[1]]
  # sum_mat[sum_mat == 0] <- NA_real_
  # sum_df <- sum_mat %>%
    
  # df %>%
  #   ggplot(aes(!!x_sym, !!y_sym, fill = after_stat(count))) +
  #   stat_density_2d(geom = "raster")
  
  # gr <- rasterlyGrob(
  #   plt,
  #   xlab = args$xlab %||% rlang::as_name(x_sym),
  #   ylab = args$ylab %||% rlang::as_name(y_sym)
  # )
  # plt <- ggRasterly(
  #   df, mapping = aes(x = !!x_sym, y = !!y_sym),
  #   plot_width = 1600, plot_height = 1200,
  #   shape = 16,
  #   # color = viridisLite::inferno(256),
  #   ...
  # ) +
  #   labs(x = args$xlab %||% rlang::as_name(x_sym), y = args$ylab %||% rlang::as_name(y_sym)) +
  #   scale_color_viridis_c(trans = "log10", option = "inferno") +
  #   theme_minimal()
  # ggsave(
  #   file.path(out_dir, paste0(out, ".pdf")), plt,
  #   width = 12, height = 8
  # )
}

plot_scatter_rasterly_3 <- function(data, x, y, out, out_dir = dir_res, ...) {
  args <- rlang::list2(...)
  x_sym <- enquo(x)
  y_sym <- enquo(y)
  df <- data %>%
    select(!!x_sym, !!y_sym) %>%
    drop_na()

  df %>%
    ggplot(aes(!!x_sym, !!y_sym)) +
    stat_bin_2d(geom = "raster", bins = c(1200, 1600)) +
    lims(x = args$x_range, y = args$y_range) +
    labs(x = args$xlab %||% rlang::as_name(x_sym), y = args$ylab %||% rlang::as_name(y_sym)) +
    scale_fill_viridis_c(trans = "log10", option = "inferno") +
    theme_minimal()

  ggsave(
    file.path(out_dir, paste0(out, ".pdf")), plt,
    width = 12, height = 8
  )
}

plt <- plot_scatter_rasterly_3(
  growth_data_bliss, gr, excess_killing, "nci_almanac_gr_vs_excess_killing_scatter_2.pdf",
  x_range = c(1.5, -3), y_range = c(-2, 2),
  xlab = "GR", ylab = "Delta Bliss"
)

plot_scatter_rasterly(
  growth_data_bliss, gr, excess_killing, "nci_almanac_gr_vs_excess_killing_scatter_2.pdf",
  x_range = c(1.5, -3), y_range = c(-2, 2),
  xlab = "GR", ylab = "Delta Bliss"
)

plot_scatter_rasterly(
  growth_data_bliss_auc, gr_min, AUC, "nci_almanac_gr_min_vs_auc_scatter.pdf",
  x_range = c(-2, 1.5), y_range = c(-5, 5),
  xlab = "GR min", ylab = "Delta Bliss AUC"
)

plot_scatter_rasterly(
  growth_data_bliss_auc, gr_mean, AUC, "nci_almanac_gr_mean_vs_auc_scatter.pdf",
  x_range = c(-0.5, 1.5), y_range = c(-5, 5),
  xlab = "GR mean", ylab = "Delta Bliss AUC"
)

plot_scatter_rasterly(
  growth_data_bliss_auc, gr_min, AUC, "nci_almanac_gr_min_vs_auc_scatter.pdf",
  x_range = c(-2, 1.5), y_range = c(-5, 5),
  xlab = "GR min", ylab = "Delta Bliss AUC"
)

 plot_scatter_rasterly(
  growth_data_bliss_auc, gr_min, excess_killing_gr_min, "nci_almanac_gr_min_vs_excess_killing_gr_min.pdf",
  x_range = c(-2, 1.5), y_range = c(-1, 1),
  xlab = "GR min", ylab = "Delta Bliss at GR min"
)


plot_scatter_rasterly(
  growth_data_bliss_auc, log_killing_max, excess_killing_log_killing_max, "nci_almanac_log_killing_max_vs_exces_killing_log_killing_max.pdf",
  x_range = c(-0.2, 2), y_range = c(-1, 1),
  xlab = "Max log killing", ylab = "Delta Bliss at max log killing"
)


## By cell line
dir_res_by_cell <- file.path(dir_res, "by_cell_line")
dir.create(dir_res_by_cell, showWarnings = FALSE)

growth_data_bliss %>%
  distinct(panel_id, cell_id) %>%
  pwalk(
    function(panel_id, cell_id) {
      cell_info <- meta_cell_line %>%
        mutate(across(c(cell_name, panel_name), str_replace_all, r"([^\w])", "_")) %>%
        filter(cell_id == !!cell_id, panel_id == !!panel_id) %>% {
          paste(.$panel_name, .$cell_name, sep = "_")
        }
      
      plot_scatter_rasterly(
        filter(growth_data_bliss, cell_id == !!cell_id, panel_id == !!panel_id),
        gr, excess_killing, paste0("nci_almanac_", cell_info, "_gr_vs_excess_killing_scatter.pdf"),
        x_range = c(1.5, -3), y_range = c(-2, 2),
        xlab = "GR", ylab = "Delta Bliss",
        out_dir = dir_res_by_cell
      )
      
      df_auc <- filter(growth_data_bliss_auc, cell_id == !!cell_id, panel_id == !!panel_id)
      plot_scatter_rasterly(
        df_auc, gr_min, AUC, paste0("nci_almanac_", cell_info, "_gr_min_vs_auc_scatter.pdf"),
        x_range = c(-2, 1.5), y_range = c(-5, 5),
        xlab = "GR min", ylab = "Delta Bliss AUC",
        out_dir = dir_res_by_cell
      )
      
      plot_scatter_rasterly(
        df_auc, gr_mean, AUC, paste0("nci_almanac_", cell_info, "_gr_mean_vs_auc_scatter.pdf"),
        x_range = c(-0.5, 1.5), y_range = c(-5, 5),
        xlab = "GR mean", ylab = "Delta Bliss AUC",
        out_dir = dir_res_by_cell
      )
      
      plot_scatter_rasterly(
        df_auc, gr_min, AUC, paste0("nci_almanac_", cell_info, "_gr_min_vs_auc_scatter.pdf"),
        x_range = c(-2, 1.5), y_range = c(-5, 5),
        xlab = "GR min", ylab = "Delta Bliss AUC",
        out_dir = dir_res_by_cell
      )
      
       plot_scatter_rasterly(
        df_auc, gr_min, excess_killing_gr_min, paste0("nci_almanac_", cell_info, "_gr_min_vs_excess_killing_gr_min.pdf"),
        x_range = c(-2, 1.5), y_range = c(-1, 1),
        xlab = "GR min", ylab = "Delta Bliss at GR min",
        out_dir = dir_res_by_cell
      )
      
      plot_scatter_rasterly(
        df_auc, log_killing_max, excess_killing_log_killing_max, paste0("nci_almanac_", cell_info, "_log_killing_max_vs_exces_killing_log_killing_max.pdf"),
        x_range = c(-0.2, 2), y_range = c(-1, 1),
        xlab = "Max log killing", ylab = "Delta Bliss at max log killing",
        out_dir = dir_res_by_cell
      )
    }
  )

```


```{r umap}
library(umap)

get_mat <- function(df, var) {
  var_sym <- enquo(var)
  df_long <- df %>%
    transmute(
      panel_cell_id = paste(panel_id, cell_id, sep = "_"),
      lspci_id_combo = paste(lspci_id_1, lspci_id_2, sep = "_"),
      !!var_sym
    )
  df_wide <- df_long %>%
    pivot_wider(names_from = lspci_id_combo, values_from = !!var_sym)
  mat <- df_wide %>%
    column_to_rownames("panel_cell_id") %>%
    as.matrix()
  mat
}

impute_mat <- function(mat, ...) {
  # imp_formula <- reformulate(paste0("`", colnames(mat), "`"))
  # Hmisc::aregImpute(
  #   imp_formula, data = as.data.frame(mat), n.impute = 5, ...
  # )
  VIM::kNN(mat, ...)
}

gr_min_mat <- get_mat(growth_data_bliss_auc, gr_min)
gr_min_mat_imp <- impute_mat(gr_min_mat)
  

umap_gr_min <- umap(
  growth_data_bliss_auc %>%
    transmute(panel_cell_id = paste(panel_id, cell_id, sep = ":"), lspci_id_1, lspci_id_2, gr_min) %>%
    pivot_wider(names_from = panel_cell_id, values_from = gr_min) %>%
    select(-starts_with("lspci_id")) %>%
    as.matrix()
)
```

* Net killing vs delta bliss, using all concentrations
* Or using AUC, adding up all values
* Stratify by cell line
* Use GR value for x-axis
* Range of delta bliss across cell line
* Plot minimum GR vs excess killing at the same doses

* UMAP of AUC values per cell line
